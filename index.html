<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OW RPG 存档计算器</title>
    <style>
        :root {
            --bg: #0f1012;
            --card-bg: #1b1c20;
            --accent: #00d2ff;
            --text-main: #ffffff;
            --text-sec: #8a8d95;
            --border: #2d3038;
            --warn: #ffcc00;
            --danger: #ff4757;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            border-bottom: 2px solid var(--accent);
            padding-bottom: 15px;
            margin-bottom: 10px;
        }

        h1 { margin: 0; color: var(--accent); font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; }
        p.desc { margin: 5px 0 0 0; color: var(--text-sec); font-size: 0.9rem; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }

        .card-header {
            font-weight: bold;
            color: var(--accent);
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .raw-preview {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-sec);
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }
        
        .field { flex: 1; }
        
        label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-sec);
            margin-bottom: 4px;
        }

        input, select {
            width: 100%;
            background: #000;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* 结果区域 */
        .result-box {
            background: #000;
            border: 1px dashed var(--text-sec);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-top: 10px;
        }

        .code-display {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1.8rem;
            color: var(--accent);
            margin: 15px 0;
            font-weight: bold;
            letter-spacing: 2px;
            word-break: break-all;
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
        }

        .calc-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid var(--border);
            padding-top: 15px;
            text-align: left;
        }

        .detail-item { font-size: 0.8rem; color: var(--text-sec); }
        .detail-item b { color: var(--text-main); display: block; font-size: 0.9rem; }

        .warn { color: var(--warn); font-size: 0.75rem; margin-top: 2px; display: none; }
        .warn.show { display: block; }
        
        button {
            background: var(--accent);
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { opacity: 0.9; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>OW RPG 存档计算器 <span style="font-size:0.6em; opacity:0.7">v2.0</span></h1>
        <p class="desc">支持计算复合属性段 (Chunk 2) | 自动修正校验位</p>
    </header>

    <div class="grid">
        <!-- 1. 等级 -->
        <div class="card">
            <div class="card-header">
                等级 (Level)
                <span class="raw-preview" id="prev-c1">Raw: 1</span>
            </div>
            <div class="field">
                <input type="number" id="level" value="1" min="1" max="8000">
                <div class="warn" id="w-level">等级超出建议范围 (1-8000)</div>
            </div>
        </div>

        <!-- 2. 门派复合数据 -->
        <div class="card">
            <div class="card-header">
                门派与属性 (Faction & Stats)
                <span class="raw-preview" id="prev-c2">Raw: 1000</span>
            </div>
            
            <div class="field">
                <label>门派 (基数)</label>
                <select id="faction">
                    <option value="1000">少林派 (1000)</option>
                    <option value="2000">武当派 (2000)</option>
                    <option value="3000">百花谷 (3000)</option>
                    <option value="4000">狮相门 (4000)</option>
                </select>
            </div>

            <div class="input-row">
                <div class="field">
                    <label>属性均值 (资质)</label>
                    <input type="number" id="attr_avg" value="0" min="0" max="50" placeholder="0-9">
                </div>
                <div class="field">
                    <label>体质等级</label>
                    <input type="number" id="body_lvl" value="0" min="0" max="20" placeholder="0-20">
                </div>
            </div>
            <div style="font-size: 0.75rem; color: #555; margin-top:5px;">
                算法: 门派 + (属性 × 100) + 体质
            </div>
        </div>

        <!-- 3. 职位复合数据 -->
        <div class="card">
            <div class="card-header">
                职位与修练 (Rank & Skill)
                <span class="raw-preview" id="prev-c3">Raw: 100</span>
            </div>
            <div class="field">
                <label>职位数值 (Rank Raw)</label>
                <input type="number" id="rank" value="100" min="100" step="100">
                <div class="warn" id="w-rank">职位数值异常 (通常100-900)</div>
            </div>
            
            <div class="field" style="margin-top:5px;">
                <label>修练加成 (Cultivation)</label>
                <input type="number" id="cultivation" value="0" min="0">
            </div>
            <div style="font-size: 0.75rem; color: #555; margin-top:5px;">
                算法: 职位 + 修练值 (0-7077)
            </div>
        </div>

        <!-- 4. 戒指 -->
        <div class="card">
            <div class="card-header">
                戒指 (Ring)
                <span class="raw-preview" id="prev-c4">Raw: 0</span>
            </div>
            <div class="input-row">
                <div class="field">
                    <label>强化 (0-20)</label>
                    <input type="number" id="r_enc" value="0">
                </div>
                <div class="field">
                    <label>精制 (0-10)</label>
                    <input type="number" id="r_ref" value="0">
                </div>
            </div>
            <div class="warn" id="w-ring">数值超出上限</div>
        </div>

        <!-- 5. 项链 -->
        <div class="card">
            <div class="card-header">
                项链 (Necklace)
                <span class="raw-preview" id="prev-c5">Raw: 0</span>
            </div>
            <div class="input-row">
                <div class="field">
                    <label>强化 (0-20)</label>
                    <input type="number" id="n_enc" value="0">
                </div>
                <div class="field">
                    <label>精制 (0-10)</label>
                    <input type="number" id="n_ref" value="0">
                </div>
            </div>
            <div class="warn" id="w-neck">数值超出上限</div>
        </div>
    </div>

    <div class="result-box">
        <div style="color:var(--text-sec); font-size:0.9rem;">实时生成的存档码</div>
        <div class="code-display" id="output">---- ---- ---- ---- ---- ----</div>
        <button onclick="copyCode()">复制到剪贴板</button>
        <span id="msg-copy" style="margin-left:10px; font-size:0.8rem; color:#4cd137;"></span>

        <div class="calc-details">
            <div class="detail-item">等级段<b id="d-c1">--</b></div>
            <div class="detail-item">门派段<b id="d-c2">--</b></div>
            <div class="detail-item">职位段<b id="d-c3">--</b></div>
            <div class="detail-item">戒指段<b id="d-c4">--</b></div>
            <div class="detail-item">项链段<b id="d-c5">--</b></div>
            <div class="detail-item" style="color:var(--accent);">校验位 (Raw)<b id="d-c6">--</b></div>
        </div>
    </div>
</div>

<script>
    // ===================================
    // 核心算法 (100% 模拟工坊逻辑)
    // ===================================
    const XOR_KEY = 2541;
    const SUB_MAP = [0, 4, 7, 1, 6, 3, 5, 2, 9, 8];

    // 加密单个数值
    function encrypt(val) {
        val = Math.floor(val);
        let b61 = val ^ XOR_KEY;

        // 计算旋转 Pivot (数位和 % 4)
        let temp = b61;
        let digitSum = 0;
        for (let i = 0; i < 4; i++) {
            digitSum += temp % 10;
            temp = Math.floor(temp / 10);
        }
        let pivot = digitSum % 4;

        // 补齐4位字符串
        let s = b61.toString().padStart(4, '0');
        // 简单处理溢出显示 (仅保留后4位参与旋转以维持格式，虽越界但可算)
        if (s.length > 4) s = s.slice(-4);

        // 右旋模拟
        let rotated = "";
        if (pivot > 0) {
            rotated = s.slice(-pivot) + s.slice(0, 4 - pivot);
        } else {
            rotated = s;
        }

        // 查表替换
        let final = "";
        for (let char of rotated) {
            final += SUB_MAP[parseInt(char)];
        }
        return final;
    }

    // 计算校验位 (工坊 Rule 164 模拟)
    function getChecksum(inputs) {
        let acc = 0;
        // 模拟工坊数组遍历: val[i] + i
        // 且数值上限按 8000 截断
        inputs.forEach((val, i) => {
            let capped = val > 8000 ? 8000 : val;
            acc += (capped + i);
        });

        // 高数值算法
        if (acc > 875) {
            let cur = acc;
            let b64_int = 0; // 代表 b64 * 100
            
            // 优化循环为数学计算
            if (cur > 768) {
                let count = Math.ceil((cur - 768) / 740); 
                // 修正边界逻辑，确保 cur 降到 <= 768
                // 工坊逻辑: While(val > 768) { val -= 740; b64 += 0.27 }
                // 0.27 * 100 = 27
                b64_int = count * 27;
                cur = cur - (count * 740);
            }
            return Math.floor(cur + b64_int);
        } else {
            // 低数值算法
            return Math.floor(acc / 5.017) + 4756;
        }
    }

    // ===================================
    // UI 交互
    // ===================================
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(el => el.addEventListener('input', updateCalc));

    function updateCalc() {
        // 1. 获取输入
        let lvl = parseInt(document.getElementById('level').value) || 0;
        
        // 门派复合计算
        let facBase = parseInt(document.getElementById('faction').value);
        let attrAvg = parseInt(document.getElementById('attr_avg').value) || 0;
        let bodyLvl = parseInt(document.getElementById('body_lvl').value) || 0;
        // RawChunk2 = Base + (Attr * 100) + Body
        let rawFac = facBase + (attrAvg * 100) + bodyLvl;

        // 职位复合计算
        let rankBase = parseInt(document.getElementById('rank').value) || 0;
        let cultVal = parseInt(document.getElementById('cultivation').value) || 0;
        let rawRank = rankBase + cultVal;

        // 装备计算
        let rEnc = parseInt(document.getElementById('r_enc').value) || 0;
        let rRef = parseInt(document.getElementById('r_ref').value) || 0;
        let rawRing = rEnc * 100 + rRef;

        let nEnc = parseInt(document.getElementById('n_enc').value) || 0;
        let nRef = parseInt(document.getElementById('n_ref').value) || 0;
        let rawNeck = nEnc * 100 + nRef;

        // 2. 验证警告显示
        toggleWarn('w-level', lvl < 1 || lvl > 8000);
        toggleWarn('w-rank', rankBase < 100);
        toggleWarn('w-ring', rEnc > 20 || rRef > 10);
        toggleWarn('w-neck', nEnc > 20 || nRef > 10);

        // 3. 更新 Raw 预览
        document.getElementById('prev-c1').textContent = `Raw: ${lvl}`;
        document.getElementById('prev-c2').textContent = `Raw: ${rawFac}`;
        document.getElementById('prev-c3').textContent = `Raw: ${rawRank}`;
        document.getElementById('prev-c4').textContent = `Raw: ${rawRing}`;
        document.getElementById('prev-c5').textContent = `Raw: ${rawNeck}`;

        // 4. 计算校验位
        let rawSum = getChecksum([lvl, rawFac, rawRank, rawRing, rawNeck]);

        // 5. 生成最终代码
        let c1 = encrypt(lvl);
        let c2 = encrypt(rawFac);
        let c3 = encrypt(rawRank);
        let c4 = encrypt(rawRing);
        let c5 = encrypt(rawNeck);
        let c6 = encrypt(rawSum);

        // 6. 输出
        document.getElementById('output').textContent = `${c1}-${c2}-${c3}-${c4}-${c5}-${c6}`;
        
        // 底部详情
        document.getElementById('d-c1').textContent = c1;
        document.getElementById('d-c2').textContent = c2;
        document.getElementById('d-c3').textContent = c3;
        document.getElementById('d-c4').textContent = c4;
        document.getElementById('d-c5').textContent = c5;
        document.getElementById('d-c6').textContent = rawSum;
    }

    function toggleWarn(id, condition) {
        const el = document.getElementById(id);
        if (condition) el.classList.add('show');
        else el.classList.remove('show');
    }

    function copyCode() {
        const text = document.getElementById('output').textContent;
        navigator.clipboard.writeText(text).then(() => {
            const msg = document.getElementById('msg-copy');
            msg.textContent = "已复制";
            setTimeout(() => msg.textContent = "", 2000);
        });
    }

    // 初始化
    updateCalc();

</script>
</body>
</html>
