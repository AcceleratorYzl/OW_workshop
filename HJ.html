<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OW_HJ 存档生成器</title>
    <style>
        :root {
            --bg-color: #0b0c10;
            --panel-bg: rgba(31, 40, 51, 0.95);
            --input-bg: #121418;
            --accent: #66fcf1;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --border: #45a29e;
            --danger: #ff4d4d;
            --gold: #ffd700;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 0%, #1f2833 0%, #0b0c10 80%);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 20px; }

        header { text-align: center; padding-bottom: 15px; border-bottom: 1px solid rgba(102, 252, 241, 0.2); margin-bottom: 10px; }
        h1 { margin: 0; color: var(--accent); text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 10px rgba(102, 252, 241, 0.4); }
        .subtitle { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; }

        .panel { background: var(--panel-bg); border: 1px solid rgba(69, 162, 158, 0.2); border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        h2 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--gold); display: flex; align-items: center; gap: 10px; border-left: 4px solid var(--accent); padding-left: 10px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        @media (max-width: 768px) { .grid-2, .grid-4 { grid-template-columns: 1fr; } }

        .field-group { display: flex; flex-direction: column; }
        label { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; font-weight: 600; color: var(--accent); margin-bottom: 5px; }

        input, select { background: var(--input-bg); border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; font-size: 0.9rem; outline: none; width: 100%; box-sizing: border-box; font-family: 'Consolas', 'Segoe UI', sans-serif; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 5px rgba(102, 252, 241, 0.2); }
        input:disabled, input[readonly], select:disabled { opacity: 0.7; background: #222; cursor: default; border-color: #444; color: #888; }
        .hint { font-size: 0.7rem; color: #666; margin-top: 3px; text-align: right; }

        .chk-group { display: flex; gap: 15px; margin-top: 8px; }
        .chk-label { color: var(--text-main); font-weight: normal; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        .output-section { background: #000; border: 1px dashed var(--border); padding: 20px; text-align: center; border-radius: 10px; margin-top: 10px; position:relative; }
        
        .status-box {
            font-family: 'Consolas', monospace; font-size: 1.2rem; margin: 15px 0; text-align: center;
            min-height: 40px; display: flex; align-items: center; justify-content: center; letter-spacing: 2px;
        }
        .status-box.waiting { color: #666; }
        .status-box.success { color: var(--accent); font-weight: bold; text-shadow: 0 0 10px rgba(102, 252, 241, 0.4); }
        .status-box.error { color: var(--danger); }
        .status-box.loading { color: var(--gold); font-style: italic; }

        .btn {
            background: transparent; color: var(--accent); border: 2px solid var(--accent); padding: 10px 40px; font-size: 1rem; border-radius: 30px;
            cursor: pointer; font-weight: bold; transition: all 0.3s;
        }
        .btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }
        .btn:disabled { border-color: #555; color: #777; cursor: not-allowed; box-shadow: none; background: transparent; }
        
        .server-tag { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; color: #444; background: #111; padding: 2px 6px; border: 1px solid #222; border-radius: 4px;}
        #api-url { display: none; }
        
        .help-tip { font-size: 0.8rem; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>RPG 存档生成器</h1>
        <div class="subtitle">皇家赛道 · 逆天修仙传2.0</div>
    </header>

    <div class="panel">
        <h2>身份信息 (Identity)</h2>
        <div class="grid-2">
            <div class="field-group">
                <label>玩家 ID (UI模拟)</label>
                <input type="text" id="pid" value="Player">
            </div>
            <div class="field-group">
                <label>随机盐 (Key)</label>
                <select id="key">
                    <option value="3" selected>Type 3</option>
                    <option value="4">Type 4</option>
                    <option value="5">Type 5</option>
                    <option value="6">Type 6</option>
                    <option value="7">Type 7</option>
                    <option value="8">Type 8</option>
                    <option value="9">Type 9</option>
                </select>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>门派与状态 (Sect & Stats)</h2>
        <div class="grid-4">
            <div class="field-group">
                <label>门派归属</label>
                <select id="sect"></select> 
            </div>
            <div class="field-group">
                <label>门派职务</label>
                <select id="role"></select>
            </div>
            <div class="field-group">
                <label>门派功勋</label>
                <input type="number" id="merit">
            </div>
             <div class="field-group">
                <label>人物等级 (Auto)</label>
                <input type="text" id="lv" readonly>
            </div>
        </div>
        <div style="height: 15px;"></div>
        <div class="grid-4">
            <div class="field-group">
                <label>精纯等级</label>
                <input type="number" id="tier" max="18" min="0" value="18">
            </div>
            <div class="field-group">
                <label>轮回周目</label>
                <input type="number" id="cycle" value="0" max="4" min="0">
            </div>
             <div class="field-group">
                <label>持有金钱</label>
                <input type="number" id="money" value="3500000" step="10000">
            </div>
            <div class="field-group">
                <label>历练值</label>
                <input type="number" id="exp" value="100000" step="1000">
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>气运与配置 (Config)</h2>
        <div class="grid-2">
            <div class="field-group">
                <label>先天气运</label>
                <select id="luck"></select>
            </div>
            <div class="field-group">
                <label>全收集 (建议开启)</label>
                <div class="chk-group">
                    <label class="chk-label"><input type="checkbox" id="ck_bk" checked> 奇书 (状态3)</label>
                    <label class="chk-label"><input type="checkbox" id="ck_sk" checked> 内功 (大成)</label>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>专属宝物 (Special Treasure)</h2>
        <div style="display: flex; gap: 15px;">
            <div class="field-group" style="flex: 2;">
                <label>主词条</label>
                <select id="tm"></select>
            </div>
            <div class="field-group" style="flex: 2;">
                <label>副词条</label>
                <select id="ts"></select>
            </div>
            <div class="field-group" style="flex: 2;">
                <label>品阶</label>
                <select id="tg" class="g-sel" disabled></select>
            </div>
            <div class="field-group" style="flex: 1;">
                <label>强化等级</label>
                <input type="number" id="te" value="0" max="99" min="0">
            </div>
        </div>
    </div>

    <div class="panel">
        <h2>装备配置 (Equipment)</h2>
        <div class="grid-2">
            <div style="display: flex; gap: 10px;">
                <div class="field-group" style="flex: 1.9;"><label>武器</label><select id="gw"></select></div>
                <div class="field-group" style="flex: 1.1;"><label>品阶</label><select id="grw" class="g-sel" disabled></select></div>
            </div>
             <div style="display: flex; gap: 10px;">
                <div class="field-group" style="flex: 1.9;"><label>冠饰</label><select id="gh"></select></div>
                <div class="field-group" style="flex: 1.1;"><label>品阶</label><select id="grh" class="g-sel" disabled></select></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="field-group" style="flex: 1.9;"><label>护甲</label><select id="gb"></select></div>
                <div class="field-group" style="flex: 1.1;"><label>品阶</label><select id="grb" class="g-sel" disabled></select></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="field-group" style="flex: 1.9;"><label>护手</label><select id="ga"></select></div>
                <div class="field-group" style="flex: 1.1;"><label>品阶</label><select id="gra" class="g-sel" disabled></select></div>
            </div>
        </div>
    </div>

    <div class="output-section">
        <div style="color:var(--text-muted); font-size:0.9rem;">控制台生成控制</div>
        
        <div class="status-box waiting" id="status">等待指令 (READY)</div>
        
        <button class="btn" id="btn-send" onclick="sendToBackend()">发送至服务器生成</button>
        <div class="help-tip">提示：生成后请后端服务器复制结果</div>
        
        <div class="server-tag">Target: larissa-teeny...dev</div>
        
        <input type="hidden" id="api-url" value="https://larissa-teeny-radiologically.ngrok-free.dev">
    </div>
</div>

<script>
    const pad = n => n < 10 ? "0"+n : n;
    const opt = (el,t,v) => el.add(new Option(t,v));
    const $ = i => document.getElementById(i);

    const D = {
        s: ["无门派", "金刚宗", "五仙教", "璇女派", "铸剑山庄", "血犼教"],
        r: [["流浪者"],["净火童","罗刹院弟子","金刚院弟子","不动殿弟子","金刚力士","护法尊者","上尊","明王","法王"],["教众","五毒部众","花蛊部众","五毒使","仙娘使","族长","巫相","圣女","教主"],["婢子","外门弟子","内门弟子","天音阁弟子","守玉人","霓裳使","羽衣使","大师姐","掌门"],["火工","学徒","青君匠","百辟匠","镇山匠","玄鸿匠","七星匠","宗匠","庄主"],["杂役","教众","精英","血童子","护法","血犼圣使","长老","副教主","教主"]],
        lk: ["无","磨砺","聚财","牛刀小试","天生战狂","凤凰灵体","不动明王","金刚不坏","武圣转世","天命之子"],
        tm: ["无", "降龙玄铁戒", "万象云光帕", "昆仑玉册", "涅槃珠", "九乌眼", "上尊金身", "开天珠", "雷鼓灵旗", "紫皇香炉"],
        tmAttr: ["无", "攻击", "血量", "破体", "御体", "吸血", "减伤", "暴击率", "暴击伤害", "治疗量"],
        ts: ["无", "攻击", "生命", "破体", "御体", "吸血", "减伤", "暴击", "暴击伤害", "治疗"],
        gr: ["下九品", "中八品", "上七品", "奇六品", "秘五品", "极四品", "超三品", "绝二品", "神一品", "绝世孤品"],
        gear: {
            w: { s:["暴击","暴击伤害","攻击"], l:"素剑_七指剑_紫虚剑_白虹剑_定岚剑_鱼肠剑_巨阙千钧剑_七星龙渊剑_---☆---_湛卢剑_朴刀_宿铁刀_雁翎刀_凤翅刀_新亭侯刀_大夏龙雀刀_百岳_鸿鹄刀_---☆---_斩龙铡_烧火棍_齐眉棍_水火五行棍_连珠飞棍_扫霞棍_嗔痴棍_赤梢疯魔棍_神影八卦棍_---☆---_达摩棍".split("_") },
            h: { s:["破体","御体","治疗"], l:"晶玉簪_珠玑冠_玉扉彩钿_流霜冠_幽芒烁_冰璃点翠_九华朱心簪_离人簪_---☆---_空明冠_头陀铁箍_镔钢盔_宿卫兜_将军乌油兜_八宝虎头盔_金刚笠_铁卧龙_大鳌逆鳞兜_---☆---_九头蛟_白木簪_鹤嘴乌纹簪_鱼龙冠_泼墨鸳鸯_红梅朱簪_百花蝴蝶簪_伏龙隐香簪_黄龙宝冠_---☆---_昭辰宝束".split("_") },
            b: { s:["自愈","减伤","血量"], l:"玉背心_嵌玉甲_琼琳衣_卷云黄甲_繁霜衣_蛟妾玉甲_彩缕玉衣_雪璃宝甲_---☆---_素暝宝莲衣_元铜衣_大叶甲_寸金软衣_雁翎甲_赤金铠_黄龙掩心衣_虬伏胄_玄珠袍_---☆---_金蚕宝甲_木札甲_烟波甲_七翎木甲_赤鸮衣_净邪木甲_朱雀五结衣_白巧玲珑甲_枯焕甲_---☆---_玄黄木甲".split("_") },
            a: { s:["破体","御体","吸血"], l:"玉裹手_半弧臂饰_冰晶手串_景云臂珰_莲华约腕_守静环_悟真环_净垢环_---☆---_希夷环_黑铁护臂_环锁缠臂_柳叶护膊_精钢环臂_乌锤臂甲_卧霜护臂_螭虎臂甲_擎云锁雷_---☆---_金蝉宝镯_木护腕_铁木护臂_虎符缠臂_象雕臂环_鬼首护膊_狮王臂甲_定意降魔环_五智佛光_---☆---_圆觉环".split("_") }
        }
    };

    window.onload = function() {
        D.s.forEach((n,i) => opt($('sect'), `[${pad(i)}] ${n}`, i));
        D.lk.forEach((n,i) => opt($('luck'), `[${pad(i)}] ${n}`, i));
        D.tm.forEach((n,i) => { let attr = i>0 ? `(${D.tmAttr[i]})` : ""; opt($('tm'), `[${pad(i)}] ${n} ${attr}`, i); });
        D.ts.forEach((n,i) => opt($('ts'), `[${pad(i)}] ${n}`, i));
        $('tm').value = 9; $('ts').value = 9;

        ['tg', 'grw', 'grh', 'grb', 'gra'].forEach(id => {
            for(let i = 9; i >= 0; i--) { let val = i+1; opt($(id), `[${pad(val)}] ${D.gr[i]}`, val); }
            opt($(id), "[00] 无", 0);
            // 修改点：强制所有品阶为神一品 (Value 9)
            $(id).value = 9; 
        });

        $('sect').addEventListener('change', refreshRoles);
        $('role').addEventListener('change', autoMerit);
        $('tier').addEventListener('input', () => { $('lv').value = 30 + (parseInt($('tier').value)||0)*30; resetStatus(); });
        document.querySelectorAll('input, select').forEach(el => { el.addEventListener('input', resetStatus); el.addEventListener('change', resetStatus); });

        initGearsStrict();
        $('sect').value = 5; refreshRoles(); 
        $('luck').value = 9; $('lv').value = 570;
    };

    // 状态重置 (但不清除正在Loading的状态)
    function resetStatus() {
        const s = $('status');
        const b = $('btn-send');
        if (!b.disabled && !s.classList.contains('waiting')) {
            s.className = "status-box waiting";
            s.innerText = "设置已更改 (READY)";
            b.innerText = "发送至服务器生成";
        }
    }

    function initGearsStrict() {
        ['w','h','b','a'].forEach(k => {
            let el = $('g'+k); let list = D.gear[k].l; let attrs = D.gear[k].s; 
            opt(el, `[00] 空 (None)`, "-1");
            let realIdx = 0; let displayNum = 1; let starBuffer = ""; 
            list.forEach(item => {
                if (item === "---☆---") { starBuffer = "---☆---"; return; }
                let itemName = starBuffer + item;
                let matIndex = Math.floor(realIdx / 9);
                let correctTypeID = (realIdx % 9) + 1;
                let valData = JSON.stringify({t: correctTypeID, m: (matIndex+1)});
                opt(el, `[${pad(displayNum)}] ${itemName} (${attrs[matIndex]||""})`, valData);
                starBuffer = ""; realIdx++; displayNum++;
            });
            el.selectedIndex = el.options.length - 1;
        });
    }

    function refreshRoles() {
        let sId = parseInt($('sect').value), rEl = $('role'); rEl.innerHTML = "";
        if (sId === 0) { opt(rEl, "[00] 无", 0); autoMerit(); return; }
        D.r[sId].forEach((n, i) => opt(rEl, `[${pad(i)}] ${n}`, i));
        rEl.value = 8; autoMerit();
    }
    function autoMerit() { let i = parseInt($('role').value) || 0; $('merit').value = (i === 8) ? 900 : i * 100; resetStatus();}
    function getG(gid, grid) {
        let raw = $(gid).value; if (raw === "-1") return "0"; 
        try { let d = JSON.parse(raw); let grade = parseInt($(grid).value); if (grade === 0) return "0"; return `数组(${d.t}, ${grade}, ${d.m}, 0, 0, 0, 0)`; } catch(e) { return "0"; }
    }

    // 冷却标志
    let isCooldown = false;
    // 冷却时间 (秒)
    const COOLDOWN_SEC = 5;

    async function sendToBackend() {
        if(isCooldown) return;

        const s = $('status'), b = $('btn-send'), api = $('api-url').value;
        const sect = parseInt($('sect').value);
        const roleIdx = parseInt($('role').value);
        let roleVal = 0;
        if (sect !== 0) roleVal = (roleIdx === 8) ? 900 : (roleIdx + 1) * 100;

        // --- 1. 发送前锁定 ---
        b.disabled = true; 
        b.innerText = "正在传输数据...";
        s.className = "status-box loading"; s.innerText = "TRANSMITTING...";

        // 构建数据
        const payload = {
            sect: sect,
            roleVal: roleVal,
            merit: parseInt($('merit').value),
            tier: parseInt($('tier').value),
            cycle: parseInt($('cycle').value),
            money: parseInt($('money').value),
            exp: parseInt($('exp').value),
            luck: parseInt($('luck').value),
            ck_bk: $('ck_bk').checked,
            ck_sk: $('ck_sk').checked,
            tm: parseInt($('tm').value),
            ts: parseInt($('ts').value),
            tg: parseInt($('tg').value),
            te: parseInt($('te').value),
            gear_w: getG('gw', 'grw'),
            gear_h: getG('gh', 'grh'),
            gear_b: getG('gb', 'grb'),
            gear_a: getG('ga', 'gra')
        };

        try {
            const res = await fetch(`${api}/api/generate_action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (data.success) {
                // --- 2. 成功后进入冷却 ---
                s.className = "status-box success";
                s.innerText = "✓ 生成成功! 请去后台查看代码";
                
                // 开始冷却倒计时
                activateCooldown(COOLDOWN_SEC);

            } else { throw new Error(data.error); }
        } catch(e) {
            // --- 失败则直接恢复 ---
            s.className = "status-box error";
            s.innerText = "Error: 连接失败";
            b.innerText = "重试";
            b.disabled = false;
            console.error(e);
        }
    }

    // 冷却逻辑函数
    function activateCooldown(seconds) {
        isCooldown = true;
        let remaining = seconds;
        const b = $('btn-send');
        
        b.disabled = true; // 保持禁用
        b.innerText = `生成成功，冷却中 (${remaining}s)`;

        const interval = setInterval(() => {
            remaining--;
            if (remaining <= 0) {
                clearInterval(interval);
                isCooldown = false;
                // 冷却结束，恢复可用状态
                b.disabled = false;
                b.innerText = "点击重新生成";
            } else {
                b.innerText = `生成成功，冷却中 (${remaining}s)`;
            }
        }, 1000);
    }
</script>

</body>
</html>
